{#{% extends 'base.html' %}#}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'assets1/whatsapp.css' %}">
    <title>Chat</title>
</head>
<body>


    <!-- start: Chat -->
    <section class="chat-section">
        <div class="chat-container">
            <!-- start: Sidebar -->
            <aside class="chat-sidebar">
                <a href="#" class="chat-sidebar-logo">
                    <i class="ri-chat-1-fill"></i>
                </a>
                <ul class="chat-sidebar-menu">
                    <li class="active"><a href="#" data-title="Chats"><i class="ri-chat-3-line"></i></a></li>
                    <li><a href="#" data-title="Contacts"><i class="ri-contacts-line"></i></a></li>
                    <li><a href="#" data-title="Documents"><i class="ri-folder-line"></i></a></li>
                    <li><a href="#" data-title="Settings"><i class="ri-settings-line"></i></a></li>
                    <li class="chat-sidebar-profile">
                        <button type="button" class="chat-sidebar-profile-toggle">
                            <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8cGVvcGxlfGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60" alt="">
                        </button>
                        <ul class="chat-sidebar-profile-dropdown">
                            <li><a href="#"><i class="ri-user-line"></i> Profile</a></li>
                            <li><a href="#"><i class="ri-logout-box-line"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </aside>
            <!-- end: Sidebar -->
            <!-- start: Content -->
            <div class="chat-content">
                <!-- start: Content side -->

                <!-- end: Content side -->
            {% for username in usernames %}
                <div class="conversation main-convo
                    {% for direct in directs %}
                        {% if username == direct.recipient.username %}active{% endif %}
                    {% endfor %}" id="{{ username }}">
                    <div class="conversation-top">
                        <a href="{% url 'inbox' %}" style="text-decoration:none;">
                         <button type="button" class="conversation-back"><i class="ri-arrow-left-line"></i></button>
                        </a>
                        <div class="conversation-user">
                            <img class="conversation-user-image" src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8cGVvcGxlfGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60" alt="">
                            <div>
                                {% for direct in directs %}
                                    {% if forloop.first %}
                                        <div class="conversation-user-name">{{ direct.recipient.username }}</div>
                                    {% endif %}
                                {% endfor %}
                                <div class="conversation-user-status online">online</div>
                            </div>
                        </div>
                        <div class="conversation-buttons">
                            <button type="button"><i class="ri-phone-fill"></i></button>
                            <button type="button"><i class="ri-vidicon-line"></i></button>
                            <button type="button"><i class="ri-information-line"></i></button>
                        </div>
                    </div>
                    <div class="conversation-main">
                        <ul class="conversation-wrapper">
                            <div class="coversation-divider"><span>Today</span></div>

                            {% for direct in directs %}
                                {% if direct.sender == request.user and direct.recipient.username == username %}
                                    <li class="conversation-item me">
                                        <div class="conversation-item-side">
                                            <img class="conversation-item-image" src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8cGVvcGxlfGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60" alt="">
                                        </div>
                                        <div class="conversation-item-content">
                                            <div class="conversation-item-wrapper">
                                                <div class="conversation-item-box">
                                                    <div class="conversation-item-text">
                                                        {% if direct.body %}<p>{{ direct.body }}</p>{% endif %}
                                                        <div class="conversation-item-time">{{ direct.date|date:"d M, P" }}</div>
                                                    </div>
                                                    <div class="conversation-item-dropdown">
                                                        <button type="button" class="conversation-item-dropdown-toggle"><i class="ri-more-2-line"></i></button>
                                                        <ul class="conversation-item-dropdown-list">
                                                            <li><a href="#"><i class="ri-share-forward-line"></i> Forward</a></li>
                                                            <li><a href="#"><i class="ri-delete-bin-line"></i> Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                {% elif direct.sender.username == username and direct.recipient == request.user %}
                                    <li class="conversation-item">
                                        <div class="conversation-item-side">
                                            <img class="conversation-item-image" src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8cGVvcGxlfGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60" alt="">
                                        </div>
                                        <div class="conversation-item-content">
                                            <div class="conversation-item-wrapper">
                                                <div class="conversation-item-box">
                                                    <div class="conversation-item-text">
                                                        {% if direct.body %}<p>{{ direct.body }}</p>{% endif %}
                                                        <div class="conversation-item-time">{{ direct.date|date:"d M, P" }}</div>
                                                    </div>
                                                    <div class="conversation-item-dropdown">
                                                        <button type="button" class="conversation-item-dropdown-toggle"><i class="ri-more-2-line"></i></button>
                                                        <ul class="conversation-item-dropdown-list">
                                                            <li><a href="#"><i class="ri-share-forward-line"></i> Forward</a></li>
                                                            <li><a href="#"><i class="ri-delete-bin-line"></i> Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    <form class="conversation-form" method="POST" enctype="multipart/form-data" role="form" action="{% url 'send_chat' %}">
                        {% csrf_token %}
                            <button type="button" class="conversation-form-button"><i class="ri-emotion-line"></i></button>
                            <div class="conversation-form-group">
                                <input type="hidden" name="to_user" value="{{ active_direct }}">
                                <input class="conversation-form-input" name="body" rows="1" placeholder="Type here..."/>
                                <button type="button" class="conversation-form-record"><i class="ri-mic-line"></i></button>
                            </div>
                            <button type="submit" class="conversation-form-button conversation-form-submit"><i class="ri-send-plane-2-line"></i></button>
                    </form>
                </div>
            {% endfor %}

                <!-- end: Conversation -->
            </div>
            <!-- end: Content -->
        </div>
    </section>
    <!-- end: Chat -->

    <script>
        // start: Sidebar
document.querySelector('.chat-sidebar-profile-toggle').addEventListener('click', function(e) {
    e.preventDefault()
    this.parentElement.classList.toggle('active')
})

document.addEventListener('click', function(e) {
    if(!e.target.matches('.chat-sidebar-profile, .chat-sidebar-profile *')) {
        document.querySelector('.chat-sidebar-profile').classList.remove('active')
    }
})
// end: Sidebar



// start: Coversation
document.querySelectorAll('.conversation-item-dropdown-toggle').forEach(function(item) {
    item.addEventListener('click', function(e) {
        e.preventDefault()
        if(this.parentElement.classList.contains('active')) {
            this.parentElement.classList.remove('active')
        } else {
            document.querySelectorAll('.conversation-item-dropdown').forEach(function(i) {
                i.classList.remove('active')
            })
            this.parentElement.classList.add('active')
        }
    })
})

document.addEventListener('click', function(e) {
    if(!e.target.matches('.conversation-item-dropdown, .conversation-item-dropdown *')) {
        document.querySelectorAll('.conversation-item-dropdown').forEach(function(i) {
            i.classList.remove('active')
        })
    }
})

document.querySelectorAll('.conversation-form-input').forEach(function(item) {
    item.addEventListener('input', function() {
        this.rows = this.value.split('\n').length
    })
})


// Conversation back button click event
document.querySelectorAll('.conversation-back').forEach(function(item) {
    item.addEventListener('click', function(e) {
        //e.preventDefault();
        this.closest('.conversation').classList.remove('active');
         //document.querySelector('.conversation-default').classList.add('active');
    });
});

// Conversation link click event
document.querySelectorAll('[data-conversation]').forEach(function(item) {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.conversation').forEach(function(i) {
            i.classList.remove('active');
        });
        document.querySelector(this.dataset.conversation).classList.add('active');

        var conversationUrl = this.getAttribute('href');
        var conversationId = this.dataset.conversation;
        var conversationElement = document.querySelector('.main-convo#' + conversationId);

        // Perform AJAX request to update the URL dynamically
        var xhr = new XMLHttpRequest();
        xhr.open('GET', conversationUrl);
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Update the URL
                history.pushState(null, '', conversationUrl);

                // Refresh the content of the selected conversation only
                conversationElement.innerHTML = xhr.responseText;
            }
        };
        xhr.send();
    });
});






    </script>
</body>
</html>